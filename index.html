<script>
    // Updated Channel List with TNT Sports added
    const channels = {
        willow: {
            name: 'WILLOW PLUS',
            manifest: 'https://amg01269-amg01269c1-sportstribal-emea-5204.playouts.now.amagi.tv/ts-eu-w1-n2/playlist/amg01269-willowtvfast-willowplus-sportstribalemea/playlist.m3u8'
        },
        tnt1: {
            name: 'TNT 1',
            manifest: 'http://sewv654wfcsdwfi87fwvgbngh.siauliairsavlt.pw/iptv/HBX28K5SXCR6EH/6566/index.m3u8'
        },
        tnt2: {
            name: 'TNT 2',
            manifest: 'http://sewv654wfcsdwfi87fwvgbngh.siauliairsavlt.pw/iptv/HBX28K5SXCR6EH/2506/index.m3u8'
        },
        tnt3: {
            name: 'TNT 3',
            manifest: 'http://sewv654wfcsdwfi87fwvgbngh.siauliairsavlt.pw/iptv/HBX28K5SXCR6EH/6564/index.m3u8'
        },
        tnt4: {
            name: 'TNT 4',
            manifest: 'http://sewv654wfcsdwfi87fwvgbngh.siauliairsavlt.pw/iptv/HBX28K5SXCR6EH/19054/index.m3u8'
        }
    };

    let playerInstance;
    let hls;

    const switcher = document.getElementById('switcher-container');
    
    // Dynamically create buttons for all channels
    Object.keys(channels).forEach((id, index) => {
        const btn = document.createElement('button');
        btn.className = `s-btn ${index === 0 ? 'active' : ''}`;
        btn.id = `btn-${id}`;
        btn.innerText = channels[id].name;
        btn.onclick = () => switchStream(id);
        switcher.appendChild(btn);
    });

    function unlockSite() {
        document.getElementById('popup').classList.add('hidden');
        document.getElementById('content').style.display = 'block';
        // Initializes with the first channel in the list
        const firstChannel = Object.keys(channels)[0];
        initPlayer(firstChannel);
    }

    function initPlayer(id) {
        const video = document.getElementById('player');
        const source = channels[id].manifest;

        if (hls) { hls.destroy(); }

        if (Hls.isSupported()) {
            hls = new Hls({
                // Added high compatibility settings for IPTV links
                enableWorker: true,
                lowLatencyMode: true,
            });
            hls.loadSource(source);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                const availableQualities = hls.levels.map((l) => l.height);
                availableQualities.unshift(-1);

                if (!playerInstance) {
                    playerInstance = new Plyr(video, {
                        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                        quality: {
                            default: -1,
                            options: availableQualities,
                            forced: true,
                            onChange: (q) => { 
                                if (q === -1) {
                                    hls.currentLevel = -1;
                                } else {
                                    hls.currentLevel = availableQualities.indexOf(q) - 1;
                                }
                            }
                        },
                        i18n: { qualityLabel: { '-1': 'Auto' } }
                    });
                }
                video.play();
            });
            
            // Error handling for unstable IPTV links
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            initPlayer(id);
                            break;
                    }
                }
            });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = source;
            if (!playerInstance) { playerInstance = new Plyr(video); }
        }
    }

    function switchStream(id) {
        document.querySelectorAll('.s-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${id}`).classList.add('active');
        initPlayer(id);
    }
</script>
